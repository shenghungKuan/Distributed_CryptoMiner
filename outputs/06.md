## Test 06: Memory Leak Check [1 pts]

```

if ! ( which valgrind &> /dev/null ); then
    # "valgrind is not installed. Please install (as root) with:"
    # "pacman -Sy valgrind"
    test_end 1
fi

leak_output=$(timeout 10 valgrind \
    --trace-children=yes \
    --child-silent-after-fork=no \
    --leak-check=full \
    --track-fds=yes \
    --show-leak-kinds=all \
    --track-origins=yes \
    ./miner 8 10 'Memory Leak Check' 2>&1)

echo "${leak_output}"
==3402773== Memcheck, a memory error detector
==3402773== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.
==3402773== Using Valgrind-3.20.0 and LibVEX; rerun with -h for copyright info
==3402773== Command: ./miner 8 10 Memory\ Leak\ Check
==3402773== 
==3402773== Conditional jump or move depends on uninitialised value(s)
==3402773==    at 0x109904: main (miner.c:156)
==3402773==  Uninitialised value was created by a stack allocation
==3402773==    at 0x1096CC: main (miner.c:137)
==3402773== 
==3402773== Use of uninitialised value of size 8
==3402773==    at 0x49950C2: _itoa_word (_itoa.c:178)
==3402773==    by 0x499EABD: __printf_buffer (vfprintf-process-arg.c:155)
==3402773==    by 0x49B98C1: __vsprintf_internal (iovsprintf.c:62)
==3402773==    by 0x499B914: sprintf (sprintf.c:30)
==3402773==    by 0x10A53E: sha1tostring (sha1.c:254)
==3402773==    by 0x109967: main (miner.c:164)
==3402773==  Uninitialised value was created by a stack allocation
==3402773==    at 0x10959A: main (miner.c:134)
==3402773== 
==3402773== Conditional jump or move depends on uninitialised value(s)
==3402773==    at 0x49950D4: _itoa_word (_itoa.c:178)
==3402773==    by 0x499EABD: __printf_buffer (vfprintf-process-arg.c:155)
==3402773==    by 0x49B98C1: __vsprintf_internal (iovsprintf.c:62)
==3402773==    by 0x499B914: sprintf (sprintf.c:30)
==3402773==    by 0x10A53E: sha1tostring (sha1.c:254)
==3402773==    by 0x109967: main (miner.c:164)
==3402773==  Uninitialised value was created by a stack allocation
==3402773==    at 0x10959A: main (miner.c:134)
==3402773== 
==3402773== Conditional jump or move depends on uninitialised value(s)
==3402773==    at 0x499EB09: __printf_buffer (vfprintf-process-arg.c:186)
==3402773==    by 0x49B98C1: __vsprintf_internal (iovsprintf.c:62)
==3402773==    by 0x499B914: sprintf (sprintf.c:30)
==3402773==    by 0x10A53E: sha1tostring (sha1.c:254)
==3402773==    by 0x109967: main (miner.c:164)
==3402773==  Uninitialised value was created by a stack allocation
==3402773==    at 0x10959A: main (miner.c:134)
==3402773== 
==3402773== Use of uninitialised value of size 8
==3402773==    at 0x499512B: _itoa_word (_itoa.c:177)
==3402773==    by 0x499EABD: __printf_buffer (vfprintf-process-arg.c:155)
==3402773==    by 0x49A0119: __vfprintf_internal (vfprintf-internal.c:1474)
==3402773==    by 0x4995EAE: printf (printf.c:33)
==3402773==    by 0x1099C2: main (miner.c:166)
==3402773==  Uninitialised value was created by a stack allocation
==3402773==    at 0x10959A: main (miner.c:134)
==3402773== 
==3402773== Conditional jump or move depends on uninitialised value(s)
==3402773==    at 0x499513C: _itoa_word (_itoa.c:177)
==3402773==    by 0x499EABD: __printf_buffer (vfprintf-process-arg.c:155)
==3402773==    by 0x49A0119: __vfprintf_internal (vfprintf-internal.c:1474)
==3402773==    by 0x4995EAE: printf (printf.c:33)
==3402773==    by 0x1099C2: main (miner.c:166)
==3402773==  Uninitialised value was created by a stack allocation
==3402773==    at 0x10959A: main (miner.c:134)
==3402773== 
==3402773== Conditional jump or move depends on uninitialised value(s)
==3402773==    at 0x499EB09: __printf_buffer (vfprintf-process-arg.c:186)
==3402773==    by 0x49A0119: __vfprintf_internal (vfprintf-internal.c:1474)
==3402773==    by 0x4995EAE: printf (printf.c:33)
==3402773==    by 0x1099C2: main (miner.c:166)
==3402773==  Uninitialised value was created by a stack allocation
==3402773==    at 0x10959A: main (miner.c:134)
==3402773== 
Number of threads: 8
  Difficulty Mask: 00000000001111111111111111111111
       Block data: [Memory Leak Check]

----------- Starting up miner threads!  -----------

Solution found by thread 7:
Nonce: 137422177648
Hash: A0F5B1040000000088F6B1040000000020B4B104
1291 hashes in 0.94s (1376.29 hashes/sec)
==3402773== 
==3402773== FILE DESCRIPTORS: 4 open (3 std) at exit.
==3402773== Open file descriptor 19: /home/nesaar/.local/share/code-server/logs/20230425T122326/ptyhost.log
==3402773==    <inherited from parent>
==3402773== 
==3402773== 
==3402773== HEAP SUMMARY:
==3402773==     in use at exit: 0 bytes in 0 blocks
==3402773==   total heap usage: 1,300 allocs, 1,300 frees, 55,330 bytes allocated
==3402773== 
==3402773== All heap blocks were freed -- no leaks are possible
==3402773== 
==3402773== For lists of detected and suppressed errors, rerun with: -s
==3402773== ERROR SUMMARY: 110 errors from 7 contexts (suppressed: 0 from 0)

# Check for open FDs
awk "${fd_check}" <<< "${leak_output}" \
    | grep -i '==[0-9]*==.*file descriptor' && test_end 1

# Make sure there were no leaks possible
grep -i '==[0-9]*==.*no leaks are possible' \
    <<< "${leak_output}" || test_end 1
==3402773== All heap blocks were freed -- no leaks are possible

# If none of the conditions were triggered above, the test passes.
test_end 0
```

